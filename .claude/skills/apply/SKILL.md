---
name: apply
description: 执行实现。基于提案文档执行编码和测试。当用户需要实现功能、写代码、写测试时使用。触发词：实现、编码、开发、apply。
---

# /apply - 执行实现

## 描述

基于已生成的提案文档，执行编码和测试。

**模式**：Auto 模式（默认全自动，支持阶段确认）

---

## 参数

- `$ARGUMENTS`：提案名称（可选，默认使用最新提案）

**选项**：
- `--step`：阶段确认模式，每阶段完成后等待确认
- `--skip-test`：跳过测试阶段（仅编码）

**示例**：
```
/apply user-register
/apply user-register --step
/apply --skip-test
```

---

## 执行流程

### Step 0: 确认提案

1. 确定目标提案目录（`.proposal/{feature-name}/`）
2. 检查文档完整性：
   - 1-requirements.md ✓
   - 2-design.md ✓
   - 3-api-spec.md ✓
   - 4-test-cases.md ✓
   - 5-tasks.md ✓
3. 检查是否有 `[待确认]` 项未处理
4. 显示任务摘要，确认开始

### Step 1: 编码阶段

**读取同目录下的 `CODING.md` 获取编码规范，按规范完成编码。**

**输入文档**：
- `.proposal/{feature}/1-requirements.md`
- `.proposal/{feature}/2-design.md`
- `.proposal/{feature}/3-api-spec.md`

**执行**：
1. 根据设计文档逐层实现代码
2. 每个文件创建后验证编译/构建
3. 更新 `5-tasks.md` 进度

**阶段完成输出**：
```
✅ 编码完成
├── 创建文件: X 个
├── 编译状态: 通过
└── 耗时: Xm Xs

[--step 模式] 是否继续单元测试？(y/n)
```

### Step 2: 单元测试阶段

**读取同目录下的 `UNIT-TEST.md` 获取测试规范，按规范编写单元测试。**

**输入文档**：
- `.proposal/{feature}/1-requirements.md`
- `.proposal/{feature}/4-test-cases.md`（UT-* 部分）
- 已实现的业务层代码

**执行**：
1. 创建测试文件
2. 运行测试
3. 如果失败，自动分析并修复（最多 3 次）

**阶段完成输出**：
```
✅ 单元测试完成
├── 测试类: X 个
├── 测试方法: X 个
├── 通过: X 个
├── 失败: 0 个
└── 耗时: Xm Xs

[--step 模式] 是否继续 API 测试？(y/n)
```

### Step 3: API/集成测试阶段

**读取同目录下的 `API-TEST.md` 获取测试规范，按规范编写 API 测试。**

**输入文档**：
- `.proposal/{feature}/3-api-spec.md`
- `.proposal/{feature}/4-test-cases.md`（AT-* 部分）
- 已实现的接口层代码

**执行**：
1. 创建测试文件
2. 运行测试
3. 如果失败，自动分析并修复（最多 3 次）

**阶段完成输出**：
```
✅ API 测试完成
├── 测试类: X 个
├── 测试方法: X 个
├── 通过: X 个
├── 失败: 0 个
└── 耗时: Xm Xs
```

### Step 4: 完成

1. 更新 `5-tasks.md` 所有任务状态
2. 运行全量测试验证
3. 输出最终摘要

---

## 输出

完成后显示：

```
✅ 实现完成：{feature-name}

📊 执行摘要：
├── 编码阶段
│   ├── 创建文件: X 个
│   ├── 修改文件: X 个
│   └── 编译: 通过
├── 单元测试
│   ├── 测试数: X 个
│   └── 通过率: 100%
└── API 测试
    ├── 测试数: X 个
    └── 通过率: 100%

📁 新增文件：
├── [根据实际项目结构列出]
└── ...

👉 下一步：
   1. 代码审查
   2. git add && git commit
   3. 创建 Pull Request
```

---

## 失败处理

### 编译失败

```
❌ 编译失败

错误信息：
[具体错误]

🔧 自动修复中...
[修复操作]

重新编译...
✅ 编译通过
```

### 测试失败

```
❌ 测试失败

失败用例：
- testXxx_Scenario: [错误信息]

🔧 自动修复中...
[分析原因]
[修复操作]

重新运行测试...
✅ 测试通过
```

### 多次失败

```
❌ 修复失败（已重试 3 次）

需要人工介入：
1. 检查错误信息
2. 手动修复后重新运行 /apply

最后的错误：
[错误详情]
```

---

## 注意事项

1. **文档完整性**：确保所有文档存在且无 `[待确认]` 项
2. **自动修复**：失败时自动分析并尝试修复
3. **进度追踪**：实时更新 tasks.md 中的任务状态
4. **可恢复**：失败后可以重新运行继续执行
5. **用户通知**：需要用户介入时，发送系统通知

---

## 用户通知

当需要用户介入时，发送系统通知提醒：

```bash
# macOS
osascript -e 'display notification "需要您的确认" with title "AI Workflow" sound name "Ping"'

# Linux
notify-send "AI Workflow" "需要您的确认"
```

**需要通知的时机**：
- `--step` 模式：每个阶段完成后等待确认
- 多次修复失败：需要人工介入
- 发现 `[待确认]` 项：需要用户决策后才能继续
